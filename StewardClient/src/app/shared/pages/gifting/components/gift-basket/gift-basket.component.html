<mat-card class="steward-layout-sticky-scroll">
  <mat-card-header>
    <mat-card-title>Gift Basket</mat-card-title>
    <mat-card-subtitle>
      {{ title }}
      <span *ngIf="hasGameSettings">(Game Settings: {{ selectedGameSettingsId || 'None' }})</span>
    </mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <ng-container
      *ngIf="
        !isLoading &&
        !loadError &&
        !giftResponse &&
        (!hasGameSettings || (hasGameSettings && !!selectedGameSettingsId))
      "
    >
      <item-selection
        [masterInventory]="itemSelectionList"
        (addItemEvent)="addItemtoBasket($event)"
      ></item-selection>
    </ng-container>
    <ng-container *ngIf="!isLoading && !loadError; else failState">
      <!-- Gravity is unique, master inventory is based on player inventory game settings -->
      <ng-container
        *ngIf="
          !hasGameSettings || (hasGameSettings && !!selectedGameSettingsId);
          else waitingForGameSettings
        "
      >
        <ng-container *ngIf="!giftResponse; else giftResponseState">
          <div class="table-container">
            <table mat-table [dataSource]="giftBasket" class="mat-elevation-z8">
              <ng-container matColumnDef="itemId">
                <th id="item-id-table-header" mat-header-cell *matHeaderCellDef>Id</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.id >= 0 ? element.id : 'N/A' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="description">
                <th mat-header-cell *matHeaderCellDef>Description</th>
                <td mat-cell *matCellDef="let element">
                  {{ element.description }}
                  <mat-error *ngIf="!!element.error">{{ element.error }}</mat-error>
                </td>
              </ng-container>

              <ng-container matColumnDef="quantity">
                <th id="quantity-table-header" mat-header-cell *matHeaderCellDef>Quantity</th>
                <td mat-cell *matCellDef="let element; let i = index">
                  <span class="editable" *ngIf="!element.edit">
                    {{ element.quantity | number: '1.0':'en-US' }}
                    <button
                      mat-icon-button
                      (click)="element.edit = true"
                      matTooltip="Edit item quantity"
                      aria-label="Edit item quantity"
                    >
                      <mat-icon svgIcon="steward-edit"></mat-icon>
                    </button>
                  </span>
                  <span class="edit" *ngIf="element.edit">
                    <mat-form-field>
                      <mat-label>New Quantity</mat-label>
                      <input
                        (keyup.enter)="editItemQuantity(i)"
                        [id]="'new-item-quantity-' + i"
                        type="number"
                        matInput
                        placeholder="1"
                        min="1"
                        max="999999999"
                        [value]="element.quantity"
                      />
                    </mat-form-field>
                    <button
                      mat-icon-button
                      (click)="editItemQuantity(i)"
                      matTooltip="Set new item quantity"
                      aria-label="Set new item quantity"
                    >
                      <mat-icon svgIcon="steward-approve"></mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      (click)="element.edit = false"
                      matTooltip="Edit item quantity"
                      aria-label="Cancel item quantity edit"
                    >
                      <mat-icon svgIcon="steward-close"></mat-icon>
                    </button>
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="itemType">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let element">{{ element.itemType | humanize }}</td>
              </ng-container>

              <ng-container matColumnDef="remove">
                <th id="quantity-table-header" mat-header-cell *matHeaderCellDef>Remove</th>
                <td mat-cell *matCellDef="let element; let i = index">
                  <button
                    mat-icon-button
                    color="warn"
                    matTooltip="Remove item"
                    aria-label="Remove item from gift basket"
                    (click)="removeItemFromGiftBasket(i)"
                  >
                    <mat-icon svgIcon="steward-trash"></mat-icon>
                  </button>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: displayedColumns"
                [ngClass]="{ 'row-error': !!row.error }"
              ></tr>
            </table>
          </div>
          <mat-error *ngIf="giftBasketHasErrors"
            >There are item errors in the gift basket.</mat-error
          >
        </ng-container>
      </ng-container>
    </ng-container>
  </mat-card-content>
  <mat-card-actions *ngIf="!isLoading && !loadError && !giftResponse">
    <div class="send-gift-basket-container">
      <p *ngIf="ignoreMaxCreditLimit">
        <b>Notice: </b>You are allowed to exceed the typical currency maximum of 500,000,000.
      </p>
      <form [formGroup]="sendGiftForm" (ngSubmit)="sendGiftBasket()">
        <mat-form-field appearance="fill">
          <mat-label>Gift Reason</mat-label>
          <mat-select formControlName="giftReason" (selectionChange)="giftReasonChanged($event)">
            <mat-option *ngFor="let reason of giftReasons" [value]="reason">
              {{ reason }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button
          mat-raised-button
          class="send-gift-basket"
          color="primary"
          type="submit"
          [disabled]="!isGiftBasketReady()"
        >
          Send Gift
          <span *ngIf="usingPlayerIdentities">To Player(s)</span>
          <span *ngIf="!usingPlayerIdentities">To LSP Groups</span>
        </button>
      </form>
      <button
        mat-raised-button
        color="warn"
        (click)="resetGiftBasketUI(true)"
        [disabled]="giftBasket?.data?.length <= 0"
      >
        Clear Gift Basket
      </button>
      <button
        mat-raised-button
        color="accent"
        (click)="populateGiftBasketFromReference()"
        [disabled]="!referenceInventory"
        [matTooltip]="referenceInventory ? null : 'No reference inventory selected'"
      >
        Set Inventory from Reference
      </button>
    </div>
  </mat-card-actions>
</mat-card>

<ng-template #failState>
  <div id="fail-state">
    <mat-progress-spinner *ngIf="isLoading" mode="indeterminate"></mat-progress-spinner>
    <json-dump *ngIf="loadError" [input]="loadError">Failure occured.</json-dump>
    <button
      *ngIf="loadError"
      class="reset-state"
      mat-raised-button
      color="accent"
      matTooltip="Reset the failed tool."
      (click)="resetGiftBasketUI()"
    >
      Reset Tool
    </button>
  </div>
</ng-template>

<ng-template #giftResponseState>
  <div class="gift-response-template">
    <gifting-result [giftingResult]="giftResponse"></gifting-result>
    <button
      class="reset-state"
      mat-raised-button
      color="accent"
      matTooltip="Reset gift basket."
      (click)="resetGiftBasketUI(true)"
      clickStop
    >
      Send another gift
    </button>
  </div>
</ng-template>

<ng-template #waitingForGameSettings>
  <div id="waiting-for-game-settings">
    <p>Select a player to continue.</p>
  </div>
</ng-template>
