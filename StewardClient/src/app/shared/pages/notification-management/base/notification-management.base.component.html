<div class="steward-layout-with-sidebar">
  <div class="steward-layout-sidebar-group">
    <div class="steward-layout-pane player-selection-div steward-layout-vertical-fill">
      <mat-tab-group mat-stretch-tabs class="steward-layout-vertical-fill">
        <mat-tab label="LSP Group Selection" class="steward-layout-vertical-fill">
          <ng-content select="[lspGroupSelection]"></ng-content>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>

  <div class="steward-layout-pane steward-layout-main-group">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Notification Management</mat-card-title>
        <mat-card-subtitle>{{ gameTitle | titlecase }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <ng-container *ngIf="getMonitor.status.state === 'complete'; else failstate">
          <form>
            <table mat-table [dataSource]="notifications">
              <ng-container matColumnDef="message">
                <th mat-header-cell *matHeaderCellDef>Message</th>
                <td mat-cell *matCellDef="let entry" [formGroup]="entry.formGroup">
                  <div class="message" *ngIf="!entry.edit">
                    <span *ngIf="entry.isCommunityMessage"
                      >{{ entry.formGroup.controls.message.value }}
                    </span>
                    <span class="warn" *ngIf="!entry.isCommunityMessage">
                      No message for notifications of type:
                      {{ entry.notification.notificationType }}
                    </span>
                  </div>
                  <mat-form-field *ngIf="entry.edit" appearance="fill" class="message">
                    <mat-label
                      >Message {{ entry.formGroup.controls.message.value.length }}/{{
                        messageMaxLength
                      }}</mat-label
                    >
                    <textarea
                      matInput
                      [formControl]="entry.formControls.message"
                      cdkTextareaAutosize
                      placeholder="Community Message"
                      type="text"
                      required
                    ></textarea>
                  </mat-form-field>
                </td>
              </ng-container>

              <ng-container matColumnDef="metadata">
                <th mat-header-cell *matHeaderCellDef>Metadata</th>
                <td mat-cell *matCellDef="let entry" [formGroup]="entry.formGroup">
                  <ul>
                    <!-- Notification ID -->
                    <li><b>ID:</b> {{ entry.notification.notificationId }}</li>
                    <!-- Notification Type -->
                    <li><b>Type:</b> {{ entry.notification.notificationType }}</li>
                    <!-- Sent Date -->
                    <li>
                      <b>Sent Date:</b>
                      {{ entry.notification.sentDateUtc | date: 'fullDate' }}
                    </li>
                    <!-- Expire Date -->
                    <li *ngIf="!entry.edit">
                      <b>Expire Date:</b>
                      {{ entry.formGroup.controls.expireDateUtc.value | date: 'fullDate' }}
                    </li>
                    <!-- Device Type -->
                    <li *ngIf="!entry.edit">
                      <b>Device Type:</b> {{ entry.formGroup.controls.deviceType.value | deppoh }}
                    </li>
                  </ul>

                  <ng-container *ngIf="entry.edit">
                    <mat-form-field appearance="fill" class="expiry-date">
                      <mat-label>Expire Date (mm/dd/yyyy)</mat-label>
                      <input
                        matInput
                        [matDatepicker]="picker"
                        [formControl]="entry.formControls.expireDateUtc"
                      />
                      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                      <mat-datepicker #picker></mat-datepicker>
                      <mat-hint>Expire time must be in the future</mat-hint>
                      <mat-error
                        *ngIf="entry.formGroup.controls.expireDateUtc?.hasError('is-after')"
                      >
                        Expiry time must be in the future.
                      </mat-error>
                    </mat-form-field>
                    <mat-form-field appearance="fill" class="device-type">
                      <mat-label>Device Type</mat-label>
                      <mat-select [formControl]="entry.formControls.deviceType">
                        <mat-option *ngFor="let type of deviceTypes" [value]="type">
                          {{ type | deppoh }}
                        </mat-option>
                      </mat-select>
                    </mat-form-field>
                  </ng-container>
                </td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let entry" [formGroup]="entry.formGroup">
                  <span class="editable" *ngIf="!entry.edit">
                    <button
                      class="edit"
                      mat-raised-button
                      color="primary"
                      [disabled]="!entry.isCommunityMessage"
                      (click)="editEntry(entry)"
                    >
                      <span [matTooltip]="entry.tooltip">Edit</span>
                    </button>
                    <button
                      mat-raised-button
                      color="warn"
                      matTooltip="Remove notification"
                      (click)="removeNotificationEntry(entry)"
                      clickStop
                      stateManager
                      [monitor]="entry.deleteMonitor"
                      [waitOnMonitors]="allMonitors"
                      monitorDisable
                      monitorWarn
                      monitorWarnSnackbar
                      [disabled]="!verifyDelete.checked"
                    >
                      Delete
                    </button>
                    <mat-checkbox #verifyDelete matTooltip="Check to enable deletion"
                      >Verify Deletion</mat-checkbox
                    >
                  </span>
                  <span class="edit" *ngIf="entry.edit">
                    <button
                      mat-raised-button
                      color="primary"
                      (click)="updateNotificationEntry(entry)"
                      [disabled]="!entry.formGroup.valid"
                      matTooltip="Update notification"
                      clickStop
                      stateManager
                      [monitor]="entry.postMonitor"
                      [waitOnMonitors]="allMonitors"
                      monitorDisable
                      monitorWarn
                      monitorWarnSnackbar
                    >
                      Submit
                    </button>
                    <button
                      mat-stroked-button
                      color="primary"
                      (click)="revertEntryEdit(entry)"
                      matTooltip="Cancel entry edit"
                      aria-label="Cancel entry edit"
                    >
                      Undo
                    </button>
                  </span>
                </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
              <tr
                mat-row
                class=""
                *matRowDef="let row; columns: columnsToDisplay; let entry"
                [ngClass]="{ 'non-editable': !entry.isCommunityMessage }"
              ></tr>
            </table>
          </form>
        </ng-container>
      </mat-card-content>
      <div [hidden]="notifications?.data?.length <= 0">
        <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 25]" showFirstLastButtons>
        </mat-paginator>
      </div>
    </mat-card>
  </div>
</div>

<ng-template #failstate>
  <mat-progress-spinner *ngIf="getMonitor.status.state === 'active'" mode="indeterminate">
  </mat-progress-spinner>
  <json-dump *ngIf="getMonitor.status.error" [input]="getMonitor.status.error"
    >Failed to load.</json-dump
  >
</ng-template>
