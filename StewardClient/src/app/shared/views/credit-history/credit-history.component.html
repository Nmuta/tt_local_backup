<mat-card>
  <mat-card-title-group>
    <mat-card-title>Credit History</mat-card-title>
    <mat-card-subtitle>{{ gameTitle }}</mat-card-subtitle>
    <help-popover-icon cardTitle="Credit History" confluenceName="Credit History Card">
      <p>Credit history is recovered from logs and is displayed from oldest to newest.</p>
      <p>
        Entries that occur at the same moment in time (and so have no known order) are grouped
        together.
      </p>
    </help-popover-icon>
  </mat-card-title-group>
  <mat-card-content>
    <ng-container *ngIf="!isLoading && !loadError; else failstate">
      <cdk-virtual-scroll-viewport tvsItemSize="48" headerHeight="56" class="cdk-wrapper">
        <table mat-table [dataSource]="creditHistory">
          <ng-container matColumnDef="eventTimestampUtc">
            <th mat-header-cell *matHeaderCellDef>Timestamp</th>
            <td mat-cell *matCellDef="let entry">
              <standard-absolute-time
                [timeUtc]="data(entry).eventTimestampUtc"
              ></standard-absolute-time>
            </td>
          </ng-container>
          <ng-container matColumnDef="deviceType">
            <th mat-header-cell *matHeaderCellDef>Device Type</th>
            <td mat-cell *matCellDef="let entry">
              {{ data(entry).deviceType | humanize }}
            </td>
          </ng-container>
          <ng-container matColumnDef="creditsAfter">
            <th mat-header-cell *matHeaderCellDef>Credit Total</th>
            <td mat-cell *matCellDef="let entry">
              {{ data(entry).creditsAfter | bignumber }}
            </td>
          </ng-container>
          <ng-container matColumnDef="creditAmount">
            <th mat-header-cell *matHeaderCellDef>Credit Change</th>
            <td mat-cell *matCellDef="let entry">
              {{ data(entry).creditAmount | bignumber }}
            </td>
          </ng-container>
          <ng-container matColumnDef="sceneName">
            <th mat-header-cell *matHeaderCellDef>Scene Name</th>
            <td mat-cell *matCellDef="let entry">
              {{ data(entry).sceneName | humanize }}
            </td>
          </ng-container>
          <ng-container matColumnDef="totalXp">
            <th mat-header-cell *matHeaderCellDef>Total XP</th>
            <td mat-cell *matCellDef="let entry">
              {{ data(entry).totalXp | bignumber }}
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
          <tr
            mat-row
            *matRowDef="let element; columns: columnsToDisplay"
            [class.timeMatchesAbove]="data(element).timeMatchesAbove"
            [class.timeMatchesBelow]="data(element).timeMatchesBelow"
          ></tr>
        </table>
      </cdk-virtual-scroll-viewport>

      <div class="load-more-container">
        <button
          mat-raised-button
          color="primary"
          *ngIf="showLoadMore && !loadingMore"
          (click)="loadMoreCreditUpdates()"
        >
          Load More
        </button>
        <mat-progress-spinner *ngIf="loadingMore" mode="indeterminate"></mat-progress-spinner>
      </div>
    </ng-container>
  </mat-card-content>
</mat-card>

<ng-template #failstate>
  <mat-progress-spinner *ngIf="isLoading" mode="indeterminate"></mat-progress-spinner>
  <json-dump *ngIf="loadError" [input]="loadError">Failed to load.</json-dump>
</ng-template>
