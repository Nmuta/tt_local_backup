# This file builds and packages a nuget package, as a preview.
# Designed for use with Analyzer-Documentation.

parameters:
- name: 'workingDirectory'
  displayName: "Path to a working directory where dotnet can be run. Like 'packages/Analyzer-Documentation'."
  type: string
- name: 'nugetName'
  displayName: "Name of the resulting nuget. Like 'Analyzer_Documentation'"
  type: string
# - name: 'majorVersion'
#   displayName: "Major version number. Probably 1, 2, 3"
#   type: number
# - name: 'minorVersion'
#   displayName: "Major version number. Probably 1, 2, 3"
#   type: number

jobs:
- job: Nuget_Publish
  displayName: Publish Nuget (Pre-release)
  steps:
  - template: ../prepare-nuget-project.template.yml
    parameters:
      workingDirectory: ${{parameters.workingDirectory}}
      
  - bash: |
      MAJOR=$(grep -iPo "(?<=<version>).*?(?=\.)" **/*.Package.csproj)
      MINOR=$(grep -iPo "<version>.*?\.\K.*?(?=\.)" **/*.Package.csproj)
      PATCH=$(grep -iPo "<version>.*?\..*?\.\K.*?(?=<)" **/*.Package.csproj)
      echo "##vso[task.setvariable variable=majorVersion]$MAJOR"
      echo "##vso[task.setvariable variable=minorVersion]$MINOR"
      echo "##vso[task.setvariable variable=patchVersion]$PATCH"
    displayName: Retrieve Version from .csproj
    inputs:
      workingDirectory: ${{parameters.workingDirectory}}

  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      command: build
      projects: >-
        ${{parameters.workingDirectory}}/**/*.csproj
      selectOrConfig: config
      feedRestore: 'Turn10-LiveOps'

  - task: DotNetCoreCLI@2
    displayName: Pack Nugets
    inputs:
      command: pack
      configuration: $(BuildConfiguration)
      packagesToPack: '${{parameters.workingDirectory}}/**/*.Package.csproj'
      versioningScheme: byPrereleaseNumber
      major: $(majorVersion)
      minor: $(minorVersion)
      patch: $(patchVersion)
      packDestination: '$(Build.ArtifactStagingDirectory)/'
      includeSymbols: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifact folder'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: ${{parameters.nugetName}}

  
  - task: NuGetAuthenticate@1

  - task: DotNetCoreCLI@2
    displayName: 'Push nuget to feed'
    inputs:
      command: 'push'
      packagesToPush: '$(build.artifactStagingDirectory)/${{parameters.nugetName}}*.nupkg'
      publishVstsFeed: 'Turn10-LiveOps'